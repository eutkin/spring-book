# Архитектура на практике

## Введение

Перед прочтением данной главы, ознакомьтесь с [главой про архитектуру](archicture.md).

Здесь же, мы разберем на практике принципы и приемы по построению грамотного дизайна на примере нескольких систем.

На первоначальном этапе мы не будем использовать какие-либо фреймворки и библиотеки, не будем писать реализации. 

Мы рассмотрим две системы:

* Калькулятор. Система для расчета некоторых показателей по имеющимся данным в аналитических целях.   

    Требования: 
    
    * Система принимает на вход задание, в которой описано, что необходимо посчитать, за какой период и URL на 
    который необходимо отправить результат расчета
    
    * После расчета на указанный в задаче URL должен быть отправлен результат задания
    
    * Должна быть поддержка нескольких типов заданий
    
    Формат задачи, результата определяются разработчиком. 

* Сервис для интеграции багтрекера (варианты Trello, Jira) и git репозиторием (Github, Gitlab, Bitbucket). 
    
    Требования:
    
    * При создании задачи/бага в трекере в git репозитории должна автоматически создаваться ветка с префиксом
    feature/ для задач и bugfix/ для багов
    
## Калькулятор

### Декомпозиция

Первым шагом при решении любой задачи является декомпозиция: разбиение большой задачи на части. 

Проще всего начать с функциональной декомпозиции. Попробуем определить независисые друг от друга задачи, которые должна
выполнять система, исходя из требований:

1. Система должна принимать задания, рассчитывать их, отсылать результат на внешний сервис, указанный в задании.
2. Определяем какие задачи будут выполняться быстро, а какие -- медленно. 

    * Принимать задание и возможно делать его пре-обработку -- это быстрая операция, так как не требует 
    взаимодействие с внешними системами, либо это взаимодействие относительно быстрое
     (например, запрос в бд по индексу).
    
    * Расчет задания -- медленная операция, так как аналитические запросы выполняются на больших массивах
    данных. Это гораздо медленнее, чем запрос запрос в базе по индексу (возможная операция в первой задаче) или 
    обработка в памяти.
    
    * Отправка результата задания по указанному адресу -- средняя по скорости операция. 
    Отправка POST запроса на внешний сервис
    происходит быстро, но здесь необходимо предусмотреть недоступность внешнего сервиса и ожидания его доступности 
    
    В итоге получаем 3 функциональных модуля, каждый из которых выполняет свою независимую задачу
    
3. У нас есть быстро выполнимая задача, медленно выполнимая задача и средняя. Представим, что нагрузка 
на нашу систему стала резко расти.  Первый модуль работает отлично. Но второй, рассчитывающий поступающие задания,
не успевает обрабатывать все больше возврастающий поток и начинает захлебываться под нагрузкой. В итоге, задания
не обрабатываются и производительность системы резко падает. 

    Здесь нам на помощь приходит [Замена прямых зависимостей на обмен сообщениями](archicture.md#Замена_прямых_зависимостей_на-обмен-сообщениями).