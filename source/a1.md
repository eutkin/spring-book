# Архитектура на практике

## Введение

Перед прочтением данной главы, ознакомьтесь с [главой про архитектуру](archicture.md).

Здесь же, мы разберем на практике принципы и приемы по построению грамотного дизайна на примере нескольких систем.

На первоначальном этапе мы не будем использовать какие-либо фреймворки и библиотеки, не будем писать реализации. 

Мы рассмотрим две системы:

* Калькулятор. Система для расчета некоторых показателей по имеющимся данным в аналитических целях.   

    Требования: 
    
    * Система принимает на вход задание, в которой описано, что необходимо посчитать, за какой период и URL на 
    который необходимо отправить результат расчета
    
    * После расчета на указанный в задаче URL должен быть отправлен результат задания
    
    * Должна быть поддержка нескольких типов заданий
    
    Формат задачи, результата определяются разработчиком. 

* Сервис для интеграции багтрекера (варианты Trello, Jira) и git репозиторием (Github, Gitlab, Bitbucket). 
    
    Требования:
    
    * При создании задачи/бага в трекере в git репозитории должна автоматически создаваться ветка с префиксом
    feature/ для задач и bugfix/ для багов
    
## Калькулятор

### Декомпозиция

#### Функциональная декомпозиция

Первым шагом при решении любой задачи является декомпозиция: разбиение большой задачи на задачи поменьше. 

Проще всего начать с [функциональной декомпозиции](archicture.md#_7). Попробуем определить независисые друг от друга задачи, которые должна
выполнять система, исходя из требований:

* Система должна принимать задания

* Система должна рассчитывать задания

* Система должна отправлять результат задания на внешний сервис

Теперь определяем какие задачи будут выполняться быстро, а какие -- медленно:

* Принимать задание и возможно делать его пре-обработку -- это быстрая операция, так как не требует 
взаимодействие с внешними системами, либо это взаимодействие относительно быстрое
(например, запрос в бд по индексу).
    
* Расчет задания -- медленная операция, так как аналитические запросы выполняются на больших массивах
данных. Это гораздо медленнее, чем делать запрос в базе по индексу (возможная операция в первой задаче) или 
обработка в памяти.
    
* Отправка результата задания по указанному адресу -- средняя по скорости операция. 
Отправка POST запроса на внешний сервис
происходит быстро, но здесь необходимо предусмотреть недоступность внешнего сервиса и связанные с этим сценарии. 

В итоге получаем 3 функциональных модуля, каждый из которых выполняет свою независимую задачу с разной скоростью
обработки.

??? tip "Совет" 
    Когда стоит выделять модуль в отдельный сервис?
    
    * имеет строго выделенную, независимую от других модулей зону ответственности. 
    
    * для выполнения функционала сервису необходимы только входные данные и сторонние системы: базы данных, брокеры
    сообщений, веб-сервисы.
    
    * есть требования к масштабируемости

    ??? "Термин"      
        Масштабируемость -- процесс, когда производительность системы пропорционально зависит от количества
        затраченных ресурсов. В бытовом плане чаще всего подразумевается горизонтальная машстабируемость, где
        под ресурсами имеется виду количество экземпляров сервиса


Представим, что нагрузка 
на нашу систему стала резко расти. Первый модуль работает отлично. Но второй, рассчитывающий поступающие задания,
не успевает обрабатывать возврастающий поток заданий и начинает захлебываться под нагрузкой. В итоге, задания
не обрабатываются и производительность системы резко падает, так как второй модуль становится бутылочным горлышком. 

Это происходит по причине неравномерной скорости работы модулей. Если скорость обработки у модулей отличаются
на некоторую малую величину (давайте примем ее в 1 секунду. При условии, что скорость обработки в памяти занимает
миллисекунды, то это довольно большая величина). 

Для решения этой проблемы мы можем воспользоваться приемом [Замена прямых зависимостей на обмен сообщениями](archicture.md#_10).

??? example "Пример"
    Вы пришли в дикси за хлебом. Но на данный момент открыты только две кассы, а покупателей, желающих оплатить покупки
    и уйти, гораздо больше и их количество увеличивается. То есть нагрузка на кассы превышает их производительность.
    Для оплаты хлебушка, вы встаете в **очередь**


Обмен сообщениями между модулями с разной скоростью работы мы организуем с помощью очередей. Одна очередь свяжет
модули приема и расчета заданий, другая - модуль расчета и обработки результат заданий. 

В итоге, мы получаем следующие функциональные модули:

* Модуль приема заданий

* Модуль расчета заданий

* Модуль обработки результат

* И внешние системы:
    
    * Хранилище данных
    
    * Очереди сообщений 

Очереди сообщений идут отдельной системой, так как они должны быть отказоустойчивыми и персистентными (чтобы в случае
аварий не терять сообщения)    

####     



    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    